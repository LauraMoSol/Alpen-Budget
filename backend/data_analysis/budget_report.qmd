---
title: "Budget Report"
format: html
execute:
  echo: false       # hide code
  eval: true        # actually run code
jupyter:
  kernel: ir        # R kernel
---

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
time_unit <- "day"  # options: "day", "month", "year"

# Paths
csv_path <- "/home/levolesialev/semester_project/Alpen-Budget/backend/sample_data/zkb_sample_expenses_1.csv"
reports_dir <- "/home/levolesialev/semester_project/Alpen-Budget/frontend/fast-proxima/public/reports"
if (!dir.exists(reports_dir)) dir.create(reports_dir, recursive = TRUE)
# -----------------------------
# 1. Load Libraries
# -----------------------------
library(readr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales) # for formatting dates

# -----------------------------
# 2. Load CSV
# -----------------------------
df <- read_csv(csv_path, col_types = cols(Date = col_date(format = "%d.%m.%Y")))

# -----------------------------
# 3. Prepare Data
# -----------------------------
df <- df %>%
  mutate(Debit_CHF = coalesce(`Debit CHF`, 0))

# Group by selected time unit
df_agg <- df %>%
  mutate(
    Time = case_when(
      time_unit == "day"   ~ Date,
      time_unit == "month" ~ floor_date(Date, unit = "month"),
      time_unit == "year"  ~ floor_date(Date, unit = "year")
    )
  ) %>%
  group_by(Time) %>%
  summarise(Spending = sum(Debit_CHF), .groups = "drop") %>%
  arrange(Time)

# -----------------------------
# 4. Generate Bar Chart
# -----------------------------
# Format x-axis labels depending on time_unit
x_labels <- switch(time_unit,
                   "day"   = date_format("%d.%m.%Y"),
                   "month" = date_format("%b %Y"),
                   "year"  = date_format("%Y"))

p <- ggplot(df_agg, aes(x = Time, y = Spending)) +
  geom_col(fill = "#3fa73f") +                        # green bars
  labs(
    title = paste("Spending per", time_unit),
    x = "Time",
    y = "Debit (CHF)"
  ) +
  scale_x_date(labels = x_labels) +
  theme_minimal(base_size = 14) +
  theme(
    # Card-matching dark background
    panel.background = element_rect(fill = "#1f2937", color = NA),
    plot.background  = element_rect(fill = "#1f2937", color = NA),
    
    # Grid lines subtle
    panel.grid.major = element_line(color = "#2e3a4b", size = 0.5),
    panel.grid.minor = element_line(color = "#2e3a4b", size = 0.25),
    
    # Axis text and title in white
    axis.text  = element_text(color = "white"),
    axis.title = element_text(color = "white", face = "bold"),
    
    # Rotate X labels nicely
    axis.text.x = element_text(angle = 45, hjust = 1),
    
    # Plot title styling
    plot.title = element_text(color = "white", face = "bold", size = 16, hjust = 0.5),
    
    # Remove extra spacing around plot
    plot.margin = margin(10, 10, 10, 10)
  )


# Save plot as SVG
svg_file <- file.path(reports_dir, paste0("spending_per_", time_unit, ".svg"))
ggsave(filename = svg_file, plot = p, width = 10, height = 6, device = "svg")

cat("SVG saved to:", svg_file, "\n")

# -----------------------------
# 5. Preview Table
# -----------------------------
df_agg %>% slice_head(n = 10)
```
